# Penetration Testing Guide

## Quick Start

### 1. Chạy Ứng Dụng

```bash
# Start dependencies
cd /home/user/spring-playground
docker-compose up -d

# Start application
mvn spring-boot:run
```

Đợi cho đến khi application khởi động thành công (xem log "Started PlaygroundApplication").

### 2. Chạy Basic Pen Test

```bash
cd pentest
chmod +x *.sh
./run-pentest.sh
```

Script này sẽ test các lỗ hổng phổ biến:
- ✅ IDOR vulnerabilities
- ✅ Actuator information disclosure
- ✅ SQL injection
- ✅ XSS
- ✅ Mass assignment
- ✅ Missing authentication
- ✅ Rate limiting
- ✅ Security headers
- ✅ Error information disclosure

### 3. Chạy OWASP ZAP Scan

#### Baseline Scan (Nhanh - 5-10 phút)
```bash
./run-zap-scan.sh baseline
```

#### Full Scan (Chậm - 15-30 phút)
```bash
./run-zap-scan.sh full
```

#### API Scan
```bash
./run-zap-scan.sh api
```

#### ZAP GUI Mode
```bash
./run-zap-scan.sh daemon
```
Sau đó mở browser: http://localhost:8090/zap

### 4. Xem Reports

```bash
# Basic pentest report
cat report.txt

# ZAP HTML reports
open reports/baseline-report.html
open reports/full-report.html

# Hoặc dùng browser
firefox reports/baseline-report.html
```

## Kết Quả Dự Kiến

### Critical Vulnerabilities (Expected)

1. **❌ No Authentication/Authorization**
   - Mọi endpoint đều public
   - Không cần login để truy cập data

2. **❌ IDOR (Insecure Direct Object Reference)**
   - User có thể access/modify/delete data của user khác
   - Chỉ cần biết ID là có thể truy cập

3. **❌ Actuator Endpoints Exposed**
   - `/actuator/env` lộ database credentials
   - `/actuator/loggers` có thể manipulate log levels

4. **❌ No Rate Limiting**
   - Dễ bị DoS attack
   - Không giới hạn số request

### High Vulnerabilities (Possible)

5. **⚠️ Missing Security Headers**
   - X-Frame-Options
   - Content-Security-Policy
   - HSTS

6. **⚠️ Mass Assignment**
   - Có thể set ID, timestamps qua JSON

### Medium/Low (Info)

7. **ℹ️ Verbose Error Messages**
   - Stack traces có thể bị leak

8. **ℹ️ No Input Validation**
   - Chưa có validation cho size, format

## Manual Testing Commands

### Test IDOR
```bash
BASE_URL="http://localhost:8080"

# Create user 1
curl -X POST $BASE_URL/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"victim","email":"victim@test.com"}'
# Note the ID from response

# Access user 1's data (should be restricted but isn't)
curl $BASE_URL/api/users/1

# Delete user 1 (should be restricted but isn't)
curl -X DELETE $BASE_URL/api/users/1
```

### Test Actuator
```bash
# Get environment variables (includes DB password!)
curl http://localhost:8080/actuator/env | jq '.'

# Get specific property
curl http://localhost:8080/actuator/env/spring.datasource.password

# Change log level (DoS attack vector)
curl -X POST http://localhost:8080/actuator/loggers/ROOT \
  -H "Content-Type: application/json" \
  -d '{"configuredLevel":"TRACE"}'
```

### Test SQL Injection
```bash
# Search with SQL injection payload
curl "http://localhost:8080/api/posts/search?title=test' OR '1'='1"
curl "http://localhost:8080/api/posts/search?title=test'; DROP TABLE users--"
```

### Test XSS
```bash
# Create user with XSS payload
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"<script>alert(1)</script>","email":"xss@test.com"}'

# Get user and check if payload is reflected
curl http://localhost:8080/api/users | grep script
```

### Test DoS (Rate Limiting)
```bash
# Send 100 rapid requests
for i in {1..100}; do
  curl http://localhost:8080/api/users &
done
wait
```

## Tools Installation

### Docker (Recommended)
All tools run via Docker - no installation needed!

### OWASP ZAP
```bash
# Already included in run-zap-scan.sh
docker pull ghcr.io/zaproxy/zaproxy:stable
```

### SQLMap (Optional)
```bash
pip3 install sqlmap

# Test SQL injection
sqlmap -u "http://localhost:8080/api/posts/search?title=test" \
  --batch --level=5 --risk=3
```

### Nikto (Optional)
```bash
# Ubuntu/Debian
sudo apt-get install nikto

# macOS
brew install nikto

# Scan
nikto -h http://localhost:8080
```

### Burp Suite (Optional)
Download: https://portswigger.net/burp/communitydownload

Configure proxy: 127.0.0.1:8080

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Security Scan

on: [push, pull_request]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Start services
        run: docker-compose up -d

      - name: Build and run application
        run: |
          mvn clean package -DskipTests
          java -jar target/*.jar &
          sleep 30

      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --network="host" -v $(pwd)/pentest/reports:/zap/wrk/:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://localhost:8080 \
            -r zap-report.html \
            -J zap-report.json

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v3
        with:
          name: zap-report
          path: pentest/reports/zap-report.html

      - name: Run Custom Pentest
        run: |
          cd pentest
          chmod +x run-pentest.sh
          ./run-pentest.sh || true

      - name: Check for critical vulnerabilities
        run: |
          # Fail build if critical vulns found
          if grep -q "CRITICAL" pentest/report.txt; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi
```

## Next Steps

### Fix Critical Issues

1. **Implement Authentication**
   ```xml
   <!-- Add to pom.xml -->
   <dependency>
     <groupId>org.springframework.boot</groupId>
     <artifactId>spring-boot-starter-security</artifactId>
   </dependency>
   ```

2. **Add Authorization Checks**
   ```java
   // Example in UserController
   @PreAuthorize("hasRole('ADMIN') or #id == authentication.principal.id")
   public ResponseEntity<User> getUserById(@PathVariable Long id) {
     // ...
   }
   ```

3. **Secure Actuator**
   ```yaml
   # application.yml
   management:
     endpoints:
       web:
         exposure:
           include: health,prometheus  # Only safe endpoints
     endpoint:
       env:
         enabled: false
   ```

4. **Add Rate Limiting**
   ```xml
   <!-- Add Bucket4j -->
   <dependency>
     <groupId>com.github.vladimir-bukhtoyarov</groupId>
     <artifactId>bucket4j-core</artifactId>
   </dependency>
   ```

### Regular Security Testing

- Run pentest before each release
- Add security scan to CI/CD pipeline
- Regular dependency scanning with OWASP Dependency Check
- Keep dependencies up to date
- Monitor security advisories

## Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Spring Security Docs](https://spring.io/projects/spring-security)
- [OWASP ZAP User Guide](https://www.zaproxy.org/docs/)
- [API Security Checklist](https://github.com/shieldfy/API-Security-Checklist)

## Support

For detailed vulnerability information and remediation steps, see:
- `PENTEST.md` - Comprehensive penetration testing guide
- Reports in `reports/` directory
- Security checklist in `PENTEST.md`
