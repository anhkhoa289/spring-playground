#!/bin/bash

# Create test data for penetration testing

BASE_URL="${BASE_URL:-http://localhost:8080}"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}Creating test data for penetration testing...${NC}\n"

# Check if server is running
if ! curl -s --fail --connect-timeout 5 "$BASE_URL/actuator/health" > /dev/null 2>&1; then
  echo "❌ Server is not running at $BASE_URL"
  echo "Please start the application first: mvn spring-boot:run"
  exit 1
fi

echo "✅ Server is running\n"

# Create users
echo "Creating users..."
USER_IDS=()

USERS=(
  '{"username":"alice","email":"alice@example.com"}'
  '{"username":"bob","email":"bob@example.com"}'
  '{"username":"charlie","email":"charlie@example.com"}'
  '{"username":"admin","email":"admin@example.com"}'
  '{"username":"testuser","email":"test@example.com"}'
)

for USER_DATA in "${USERS[@]}"; do
  RESPONSE=$(curl -s -X POST "$BASE_URL/api/users" \
    -H "Content-Type: application/json" \
    -d "$USER_DATA")

  USER_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
  if [ -n "$USER_ID" ]; then
    USERNAME=$(echo "$RESPONSE" | jq -r '.username')
    echo "  ✅ Created user: $USERNAME (ID: $USER_ID)"
    USER_IDS+=("$USER_ID")
  else
    echo "  ❌ Failed to create user"
  fi
done

echo ""
echo "Creating posts..."

if [ ${#USER_IDS[@]} -eq 0 ]; then
  echo "❌ No users created, skipping posts"
  exit 1
fi

POST_COUNT=0

# Create posts for each user
for USER_ID in "${USER_IDS[@]}"; do
  # Create 3-5 posts per user
  NUM_POSTS=$((3 + RANDOM % 3))

  for i in $(seq 1 $NUM_POSTS); do
    TITLE="Post #$i from User $USER_ID"
    CONTENT="This is test content for post $i. Lorem ipsum dolor sit amet, consectetur adipiscing elit."

    RESPONSE=$(curl -s -X POST "$BASE_URL/api/posts" \
      -H "Content-Type: application/json" \
      -d "{\"title\":\"$TITLE\",\"content\":\"$CONTENT\",\"userId\":$USER_ID}")

    POST_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
    if [ -n "$POST_ID" ]; then
      ((POST_COUNT++))
    fi
  done
done

echo "  ✅ Created $POST_COUNT posts"
echo ""

# Create some posts with special characters for XSS testing
echo "Creating posts with special characters (for XSS testing)..."

XSS_POSTS=(
  '{"title":"Normal Title","content":"<script>alert(1)</script>","userId":'${USER_IDS[0]}'}'
  '{"title":"<img src=x onerror=alert(1)>","content":"Normal content","userId":'${USER_IDS[0]}'}'
  '{"title":"SQL Test","content":"test'\'' OR '\''1'\''='\''1","userId":'${USER_IDS[0]}'}'
)

for XSS_POST in "${XSS_POSTS[@]}"; do
  RESPONSE=$(curl -s -X POST "$BASE_URL/api/posts" \
    -H "Content-Type: application/json" \
    -d "$XSS_POST")

  POST_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
  if [ -n "$POST_ID" ]; then
    echo "  ✅ Created XSS test post (ID: $POST_ID)"
  fi
done

echo ""
echo -e "${GREEN}======================================${NC}"
echo -e "${GREEN}Test data created successfully!${NC}"
echo -e "${GREEN}======================================${NC}"
echo ""
echo "Summary:"
echo "  - Users: ${#USER_IDS[@]}"
echo "  - Posts: $POST_COUNT+"
echo ""
echo "You can now run penetration tests:"
echo "  ./run-pentest.sh"
echo "  ./run-zap-scan.sh baseline"
echo ""
