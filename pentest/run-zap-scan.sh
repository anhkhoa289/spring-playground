#!/bin/bash

# OWASP ZAP Scanner Script for Spring Playground
# This script runs different types of ZAP scans

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TARGET_URL="${TARGET_URL:-http://host.docker.internal:8080}"
SCAN_TYPE="${1:-baseline}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}======================================${NC}"
echo -e "${BLUE}OWASP ZAP Security Scanner${NC}"
echo -e "${BLUE}======================================${NC}"
echo ""
echo -e "Target: ${GREEN}$TARGET_URL${NC}"
echo -e "Scan Type: ${GREEN}$SCAN_TYPE${NC}"
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo -e "${RED}Error: Docker is not running${NC}"
  exit 1
fi

# Create reports directory
mkdir -p "$SCRIPT_DIR/reports"

case "$SCAN_TYPE" in
  "baseline")
    echo -e "${YELLOW}Running Baseline Scan...${NC}"
    echo "This scan runs the ZAP spider and passive scanner."
    echo ""

    docker run --rm \
      -v "$SCRIPT_DIR/reports:/zap/wrk/:rw" \
      -t ghcr.io/zaproxy/zaproxy:stable \
      zap-baseline.py \
      -t "$TARGET_URL" \
      -r baseline-report.html \
      -J baseline-report.json \
      -w baseline-report.md \
      -I

    echo ""
    echo -e "${GREEN}✅ Baseline scan complete!${NC}"
    echo -e "Report: ${BLUE}$SCRIPT_DIR/reports/baseline-report.html${NC}"
    ;;

  "full")
    echo -e "${YELLOW}Running Full Scan...${NC}"
    echo "This scan runs the spider, passive scanner, and active scanner."
    echo "⚠️  This may take 15-30 minutes and will attempt to exploit vulnerabilities!"
    echo ""

    read -p "Are you sure you want to run a full scan? (yes/no) " -n 3 -r
    echo
    if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
      echo "Scan cancelled"
      exit 0
    fi

    docker run --rm \
      -v "$SCRIPT_DIR/reports:/zap/wrk/:rw" \
      -t ghcr.io/zaproxy/zaproxy:stable \
      zap-full-scan.py \
      -t "$TARGET_URL" \
      -r full-report.html \
      -J full-report.json \
      -w full-report.md \
      -I

    echo ""
    echo -e "${GREEN}✅ Full scan complete!${NC}"
    echo -e "Report: ${BLUE}$SCRIPT_DIR/reports/full-report.html${NC}"
    ;;

  "api")
    echo -e "${YELLOW}Running API Scan...${NC}"
    echo "This scan focuses on REST API endpoints."
    echo ""

    # Check if OpenAPI spec exists
    if [ -f "$SCRIPT_DIR/../openapi.yaml" ]; then
      echo "Using OpenAPI specification..."
      docker run --rm \
        -v "$SCRIPT_DIR/reports:/zap/wrk/:rw" \
        -v "$SCRIPT_DIR/../openapi.yaml:/zap/openapi.yaml:ro" \
        -t ghcr.io/zaproxy/zaproxy:stable \
        zap-api-scan.py \
        -t "$TARGET_URL" \
        -f openapi \
        -r api-report.html \
        -J api-report.json \
        -w api-report.md \
        -I
    else
      echo "No OpenAPI spec found, using target URL..."
      docker run --rm \
        -v "$SCRIPT_DIR/reports:/zap/wrk/:rw" \
        -t ghcr.io/zaproxy/zaproxy:stable \
        zap-api-scan.py \
        -t "$TARGET_URL" \
        -r api-report.html \
        -J api-report.json \
        -w api-report.md \
        -I
    fi

    echo ""
    echo -e "${GREEN}✅ API scan complete!${NC}"
    echo -e "Report: ${BLUE}$SCRIPT_DIR/reports/api-report.html${NC}"
    ;;

  "automation")
    echo -e "${YELLOW}Running Automation Framework Scan...${NC}"
    echo "This scan uses the ZAP automation framework with custom config."
    echo ""

    if [ ! -f "$SCRIPT_DIR/zap-config.yaml" ]; then
      echo -e "${RED}Error: zap-config.yaml not found${NC}"
      exit 1
    fi

    docker run --rm \
      -v "$SCRIPT_DIR/reports:/zap/wrk/:rw" \
      -v "$SCRIPT_DIR/zap-config.yaml:/zap/wrk/zap-config.yaml:ro" \
      -t ghcr.io/zaproxy/zaproxy:stable \
      zap.sh -cmd \
      -autorun /zap/wrk/zap-config.yaml

    echo ""
    echo -e "${GREEN}✅ Automation scan complete!${NC}"
    echo -e "Report: ${BLUE}$SCRIPT_DIR/reports/zap-report.html${NC}"
    ;;

  "daemon")
    echo -e "${YELLOW}Starting ZAP in Daemon Mode...${NC}"
    echo "ZAP will be available at http://localhost:8090"
    echo "API available at http://localhost:8080"
    echo ""
    echo "Press Ctrl+C to stop"
    echo ""

    docker run --rm -it \
      -v "$SCRIPT_DIR/reports:/zap/wrk/:rw" \
      -p 8090:8080 \
      -p 8081:8090 \
      ghcr.io/zaproxy/zaproxy:stable \
      zap-webswing.sh

    ;;

  *)
    echo -e "${RED}Unknown scan type: $SCAN_TYPE${NC}"
    echo ""
    echo "Usage: $0 [scan-type]"
    echo ""
    echo "Available scan types:"
    echo "  baseline     - Quick passive scan (default)"
    echo "  full         - Comprehensive active scan (slow)"
    echo "  api          - API-focused scan"
    echo "  automation   - Custom automation framework scan"
    echo "  daemon       - Start ZAP in daemon mode with GUI"
    echo ""
    echo "Examples:"
    echo "  $0 baseline"
    echo "  $0 full"
    echo "  TARGET_URL=http://example.com:8080 $0 api"
    exit 1
    ;;
esac

echo ""
echo -e "${BLUE}======================================${NC}"
echo "Scan complete! Check the reports directory:"
echo ""
ls -lh "$SCRIPT_DIR/reports/" | tail -n +2
echo ""
echo -e "${BLUE}======================================${NC}"
