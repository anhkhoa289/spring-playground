#!/bin/bash

echo "======================================"
echo "Spring Playground Penetration Testing"
echo "======================================"

BASE_URL="${BASE_URL:-http://localhost:8080}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Counter for vulnerabilities
VULN_COUNT=0

echo -e "${BLUE}Target: $BASE_URL${NC}\n"

# Check if server is running
echo "Checking if server is running..."
if ! curl -s --fail --connect-timeout 5 "$BASE_URL/actuator/health" > /dev/null 2>&1; then
  echo -e "${RED}❌ Server is not running at $BASE_URL${NC}"
  echo "Please start the application first: mvn spring-boot:run"
  exit 1
fi
echo -e "${GREEN}✅ Server is running${NC}\n"

# Test 1: IDOR Vulnerability
echo -e "${YELLOW}[TEST 1] IDOR (Insecure Direct Object Reference)${NC}"
echo "----------------------------------------"
echo "Creating test users..."

USER1=$(curl -s -X POST "$BASE_URL/api/users" \
  -H "Content-Type: application/json" \
  -d '{"username":"victim_'$(date +%s)'","email":"victim@test.com"}' 2>/dev/null | jq -r '.id // empty')

if [ -z "$USER1" ]; then
  echo -e "${RED}Failed to create test user${NC}"
else
  echo "Created User 1 with ID: $USER1"

  USER2=$(curl -s -X POST "$BASE_URL/api/users" \
    -H "Content-Type: application/json" \
    -d '{"username":"attacker_'$(date +%s)'","email":"attacker@test.com"}' 2>/dev/null | jq -r '.id // empty')
  echo "Created User 2 with ID: $USER2"

  echo "Testing if any user can access other user's data..."
  RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/api/users/$USER1")

  if [ "$RESPONSE" -eq 200 ]; then
    echo -e "${RED}❌ VULNERABLE: IDOR detected!${NC}"
    echo "   Any user can access other users' data without authentication"
    echo -e "   Severity: ${RED}CRITICAL${NC}"
    ((VULN_COUNT++))
  else
    echo -e "${GREEN}✅ SECURE: IDOR protection working${NC}"
  fi
fi
echo ""

# Test 2: Actuator Information Disclosure
echo -e "${YELLOW}[TEST 2] Actuator Information Disclosure${NC}"
echo "----------------------------------------"
echo "Testing /actuator/env endpoint..."
RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/actuator_env.json "$BASE_URL/actuator/env")

if [ "$RESPONSE" -eq 200 ]; then
  echo -e "${RED}❌ VULNERABLE: /actuator/env is publicly accessible!${NC}"
  echo "   Checking for exposed credentials..."

  # Check for sensitive data
  if grep -qi "password\|secret\|key" /tmp/actuator_env.json 2>/dev/null; then
    echo -e "${RED}   ⚠️  Found potential credentials in response:${NC}"
    grep -i "password\|secret\|key" /tmp/actuator_env.json | head -3 | sed 's/^/   /'
  fi

  echo -e "   Severity: ${RED}CRITICAL${NC}"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ SECURE: /actuator/env is protected or disabled${NC}"
fi

echo ""
echo "Testing /actuator/loggers endpoint..."
RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/actuator/loggers")

if [ "$RESPONSE" -eq 200 ]; then
  echo -e "${RED}❌ VULNERABLE: /actuator/loggers is accessible!${NC}"
  echo "   Attackers can manipulate log levels for DoS attacks"
  echo -e "   Severity: ${RED}HIGH${NC}"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ SECURE: /actuator/loggers is protected${NC}"
fi
echo ""

# Test 3: SQL Injection
echo -e "${YELLOW}[TEST 3] SQL Injection${NC}"
echo "----------------------------------------"
echo "Testing /api/posts/search endpoint..."

# Create a test post first
TEST_USER=$(curl -s -X POST "$BASE_URL/api/users" \
  -H "Content-Type: application/json" \
  -d '{"username":"sqltest_'$(date +%s)'","email":"sql@test.com"}' 2>/dev/null | jq -r '.id // empty')

if [ -n "$TEST_USER" ]; then
  curl -s -X POST "$BASE_URL/api/posts" \
    -H "Content-Type: application/json" \
    -d "{\"title\":\"Test Post\",\"content\":\"Content\",\"userId\":$TEST_USER}" > /dev/null 2>&1
fi

PAYLOADS=(
  "test' OR '1'='1"
  "test' OR 1=1--"
  "test'; DROP TABLE users--"
  "test' UNION SELECT NULL--"
)

SQLI_VULNERABLE=false
for PAYLOAD in "${PAYLOADS[@]}"; do
  ENCODED_PAYLOAD=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$PAYLOAD'))" 2>/dev/null || echo "$PAYLOAD")
  RESPONSE=$(curl -s "$BASE_URL/api/posts/search?title=$ENCODED_PAYLOAD" 2>/dev/null)

  # Check if response contains error messages or unexpected behavior
  if echo "$RESPONSE" | grep -qi "error\|exception\|sql\|syntax"; then
    echo -e "${RED}❌ POTENTIAL SQL INJECTION: Payload '$PAYLOAD' caused an error${NC}"
    SQLI_VULNERABLE=true
  fi
done

if [ "$SQLI_VULNERABLE" = true ]; then
  echo -e "   Severity: ${RED}CRITICAL${NC}"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ No obvious SQL injection vulnerabilities detected${NC}"
  echo "   (Spring Data JPA uses prepared statements by default)"
fi
echo ""

# Test 4: XSS (Cross-Site Scripting)
echo -e "${YELLOW}[TEST 4] XSS (Cross-Site Scripting)${NC}"
echo "----------------------------------------"
echo "Testing XSS in username field..."

XSS_PAYLOADS=(
  '<script>alert(1)</script>'
  '<img src=x onerror=alert(1)>'
  '"><script>alert(String.fromCharCode(88,83,83))</script>'
)

XSS_VULNERABLE=false
for XSS_PAYLOAD in "${XSS_PAYLOADS[@]}"; do
  RESPONSE=$(curl -s -X POST "$BASE_URL/api/users" \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"$XSS_PAYLOAD\",\"email\":\"xss@test.com\"}" 2>/dev/null)

  # Check if the payload is reflected without encoding
  if echo "$RESPONSE" | grep -qF "$XSS_PAYLOAD"; then
    echo -e "${RED}❌ POTENTIAL XSS: Payload reflected without sanitization${NC}"
    echo "   Payload: $XSS_PAYLOAD"
    XSS_VULNERABLE=true
  fi
done

if [ "$XSS_VULNERABLE" = true ]; then
  echo -e "   Severity: ${RED}HIGH${NC}"
  echo "   Note: Impact depends on frontend implementation"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ XSS payloads not reflected unsafely${NC}"
fi
echo ""

# Test 5: Mass Assignment
echo -e "${YELLOW}[TEST 5] Mass Assignment${NC}"
echo "----------------------------------------"
echo "Attempting to set ID directly..."

RESPONSE=$(curl -s -X POST "$BASE_URL/api/users" \
  -H "Content-Type: application/json" \
  -d '{"username":"massassign","email":"mass@test.com","id":999999,"createdAt":"1970-01-01T00:00:00"}' 2>/dev/null)

CREATED_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

if [ "$CREATED_ID" = "999999" ]; then
  echo -e "${RED}❌ VULNERABLE: Mass assignment allows setting ID${NC}"
  echo -e "   Severity: ${RED}HIGH${NC}"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ SECURE: ID cannot be set via mass assignment${NC}"
fi
echo ""

# Test 6: No Authentication
echo -e "${YELLOW}[TEST 6] Missing Authentication${NC}"
echo "----------------------------------------"
echo "Testing if API requires authentication..."

ENDPOINTS=(
  "/api/users"
  "/api/posts"
  "/actuator/health"
)

AUTH_REQUIRED=true
for ENDPOINT in "${ENDPOINTS[@]}"; do
  RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL$ENDPOINT")
  if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 201 ]; then
    echo -e "${RED}❌ $ENDPOINT is accessible without authentication (HTTP $RESPONSE)${NC}"
    AUTH_REQUIRED=false
  fi
done

if [ "$AUTH_REQUIRED" = false ]; then
  echo -e "   Severity: ${RED}CRITICAL${NC}"
  echo "   All endpoints should require authentication"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ Authentication is required${NC}"
fi
echo ""

# Test 7: Rate Limiting
echo -e "${YELLOW}[TEST 7] Rate Limiting${NC}"
echo "----------------------------------------"
echo "Sending 50 rapid requests to test rate limiting..."

SUCCESS_COUNT=0
for i in {1..50}; do
  RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/api/users" --max-time 1 2>/dev/null)
  if [ "$RESPONSE" -eq 200 ]; then
    ((SUCCESS_COUNT++))
  fi
done

if [ "$SUCCESS_COUNT" -ge 45 ]; then
  echo -e "${RED}❌ VULNERABLE: No rate limiting detected${NC}"
  echo "   $SUCCESS_COUNT/50 requests succeeded"
  echo -e "   Severity: ${RED}HIGH${NC}"
  echo "   Application is vulnerable to DoS attacks"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ SECURE: Rate limiting appears to be in place${NC}"
  echo "   Only $SUCCESS_COUNT/50 requests succeeded"
fi
echo ""

# Test 8: Security Headers
echo -e "${YELLOW}[TEST 8] Security Headers${NC}"
echo "----------------------------------------"
echo "Checking for security headers..."

HEADERS=$(curl -s -I "$BASE_URL/api/users" 2>/dev/null)

MISSING_HEADERS=()

if ! echo "$HEADERS" | grep -qi "X-Content-Type-Options"; then
  MISSING_HEADERS+=("X-Content-Type-Options")
fi

if ! echo "$HEADERS" | grep -qi "X-Frame-Options"; then
  MISSING_HEADERS+=("X-Frame-Options")
fi

if ! echo "$HEADERS" | grep -qi "Strict-Transport-Security"; then
  MISSING_HEADERS+=("Strict-Transport-Security (HSTS)")
fi

if ! echo "$HEADERS" | grep -qi "Content-Security-Policy"; then
  MISSING_HEADERS+=("Content-Security-Policy")
fi

if ! echo "$HEADERS" | grep -qi "X-XSS-Protection"; then
  MISSING_HEADERS+=("X-XSS-Protection")
fi

if [ ${#MISSING_HEADERS[@]} -gt 0 ]; then
  echo -e "${YELLOW}⚠️  Missing security headers:${NC}"
  for HEADER in "${MISSING_HEADERS[@]}"; do
    echo "   - $HEADER"
  done
  echo -e "   Severity: ${YELLOW}MEDIUM${NC}"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ All important security headers are present${NC}"
fi
echo ""

# Test 9: Error Information Disclosure
echo -e "${YELLOW}[TEST 9] Error Information Disclosure${NC}"
echo "----------------------------------------"
echo "Testing error responses for information leakage..."

RESPONSE=$(curl -s "$BASE_URL/api/users/99999999" 2>/dev/null)

if echo "$RESPONSE" | grep -qi "stacktrace\|exception\|java\|springframework"; then
  echo -e "${RED}❌ VULNERABLE: Error responses contain stack traces${NC}"
  echo -e "   Severity: ${YELLOW}MEDIUM${NC}"
  ((VULN_COUNT++))
else
  echo -e "${GREEN}✅ Error responses don't leak sensitive information${NC}"
fi
echo ""

# Summary
echo "======================================"
echo -e "${BLUE}PENETRATION TEST SUMMARY${NC}"
echo "======================================"
echo ""

if [ $VULN_COUNT -eq 0 ]; then
  echo -e "${GREEN}✅ No vulnerabilities detected!${NC}"
else
  echo -e "${RED}⚠️  Found $VULN_COUNT vulnerability/vulnerabilities${NC}"
  echo ""
  echo "Critical Issues to Fix:"
  echo "1. Implement authentication & authorization"
  echo "2. Fix IDOR vulnerabilities"
  echo "3. Secure or disable actuator endpoints"
  echo "4. Implement rate limiting"
  echo "5. Add security headers"
  echo ""
  echo "See PENTEST.md for detailed remediation steps"
fi

echo ""
echo "Full report saved to: pentest/report.txt"
echo "======================================"

exit $VULN_COUNT
