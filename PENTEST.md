# Hướng Dẫn Penetration Testing - Spring Playground

## Mục Lục
1. [Tổng Quan](#tổng-quan)
2. [Môi Trường Testing](#môi-trường-testing)
3. [Các Công Cụ Pen Test](#các-công-cụ-pen-test)
4. [API Endpoints Cần Test](#api-endpoints-cần-test)
5. [Các Lỗ Hổng Cần Kiểm Tra](#các-lỗ-hổng-cần-kiểm-tra)
6. [Test Cases Chi Tiết](#test-cases-chi-tiết)
7. [Automated Testing với OWASP ZAP](#automated-testing-với-owasp-zap)
8. [Checklist Bảo Mật](#checklist-bảo-mật)

---

## Tổng Quan

Dự án này là Spring Boot 3.5.7 REST API với PostgreSQL và Hazelcast caching. Các điểm cần chú ý:

- **Tech Stack**: Java 21, Spring Boot 3.5.7, PostgreSQL 16, Hazelcast 5.4.0
- **Actuator Endpoints**: Exposed at `/actuator/*` - **CRITICAL SECURITY RISK**
- **No Authentication**: API không có authentication/authorization
- **Caching**: Hazelcast distributed cache
- **Database**: PostgreSQL với CASCADE DELETE

### Attack Surface (Bề Mặt Tấn Công)

1. **REST API Endpoints** - `/api/users`, `/api/posts`
2. **Actuator Endpoints** - `/actuator/*` (exposed nhiều thông tin nhạy cảm)
3. **Database Injection** - SQL Injection qua JPA
4. **Cache Poisoning** - Hazelcast cache manipulation
5. **Mass Assignment** - JSON deserization vulnerabilities

---

## Môi Trường Testing

### 1. Khởi Động Application

```bash
# Start dependencies
docker-compose up -d

# Run application
mvn spring-boot:run
```

Application chạy tại: `http://localhost:8080`

### 2. Tạo Test Data

```bash
# Create test users
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser1","email":"test1@example.com"}'

curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","email":"admin@example.com"}'

# Create test posts
curl -X POST http://localhost:8080/api/posts \
  -H "Content-Type: application/json" \
  -d '{"title":"Test Post","content":"Content here","userId":1}'
```

---

## Các Công Cụ Pen Test

### 1. **OWASP ZAP** (Recommended)
```bash
# Install via Docker
docker pull ghcr.io/zaproxy/zaproxy:stable

# Run ZAP proxy
docker run -u zap -p 8081:8080 -p 8090:8090 \
  -v $(pwd)/pentest:/zap/wrk/:rw \
  -i ghcr.io/zaproxy/zaproxy:stable zap-webswing.sh
```

Access ZAP UI: `http://localhost:8090/zap`

### 2. **Burp Suite Community Edition**
- Download: https://portswigger.net/burp/communitydownload
- Configure proxy: `127.0.0.1:8080`
- Set browser proxy để intercept traffic

### 3. **curl** - Manual Testing
```bash
# Đơn giản nhất, test nhanh từ command line
curl -v http://localhost:8080/api/users
```

### 4. **Postman/Bruno** - API Testing
- Import OpenAPI spec (nếu có)
- Tạo collection để test từng endpoint

### 5. **SQLMap** - SQL Injection Testing
```bash
# Install
pip3 install sqlmap

# Test SQL injection
sqlmap -u "http://localhost:8080/api/users/1" --batch
```

### 6. **Nikto** - Web Server Scanner
```bash
# Install
apt-get install nikto

# Scan
nikto -h http://localhost:8080
```

---

## API Endpoints Cần Test

### User Controller (`/api/users`)

| Method | Endpoint | Description | Risk Level |
|--------|----------|-------------|-----------|
| GET | `/api/users` | Get all users | Medium |
| GET | `/api/users/{id}` | Get user by ID | High (IDOR) |
| GET | `/api/users/username/{username}` | Get by username | High (IDOR) |
| POST | `/api/users` | Create user | High |
| PUT | `/api/users/{id}` | Update user | Critical (IDOR) |
| DELETE | `/api/users/{id}` | Delete user | Critical (IDOR) |
| GET | `/api/users/delete-jobs/{jobId}` | Delete job status | Medium |

### Post Controller (`/api/posts`)

| Method | Endpoint | Description | Risk Level |
|--------|----------|-------------|-----------|
| GET | `/api/posts` | Get all posts | Low |
| GET | `/api/posts/{id}` | Get post by ID | Medium |
| GET | `/api/posts/user/{userId}` | Get posts by user | Medium |
| GET | `/api/posts/search?title=` | Search posts | High (SQL Injection) |
| POST | `/api/posts` | Create post | High |
| PUT | `/api/posts/{id}` | Update post | High |
| DELETE | `/api/posts/{id}` | Delete post | High |

### Actuator Endpoints (`/actuator`)

| Endpoint | Risk | Information Leaked |
|----------|------|-------------------|
| `/actuator/env` | **CRITICAL** | DB credentials, secrets |
| `/actuator/health` | Medium | System status |
| `/actuator/metrics` | Low | Performance data |
| `/actuator/prometheus` | Low | Metrics |
| `/actuator/loggers` | **HIGH** | Can change log levels! |

---

## Các Lỗ Hổng Cần Kiểm Tra

### 1. **IDOR (Insecure Direct Object Reference)**

**Mô tả**: API không check authorization, user có thể truy cập/sửa/xóa data của user khác.

**Test Cases**:
```bash
# Tạo user 1
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"victim","email":"victim@example.com"}'
# Response: {"id":1,...}

# Tạo user 2
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"attacker","email":"attacker@example.com"}'
# Response: {"id":2,...}

# IDOR Attack: User 2 xem data của User 1
curl http://localhost:8080/api/users/1
# ❌ VULNERABLE: Nên return 403 Forbidden nhưng return 200 OK

# IDOR Attack: User 2 xóa User 1
curl -X DELETE http://localhost:8080/api/users/1
# ❌ VULNERABLE: Deleted successfully!

# IDOR Attack: User 2 sửa email của User 1
curl -X PUT http://localhost:8080/api/users/1 \
  -H "Content-Type: application/json" \
  -d '{"username":"victim","email":"hacked@attacker.com"}'
# ❌ VULNERABLE: Updated successfully!
```

**Impact**: CRITICAL - Attacker có thể đọc/sửa/xóa data của bất kỳ user nào.

**Fix**: Implement authentication và authorization check trong mỗi endpoint.

---

### 2. **Mass Assignment**

**Mô tả**: JSON deserialization có thể set các field không mong muốn.

**Test Cases**:
```bash
# Thử inject thêm fields vào User object
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "username":"hacker",
    "email":"hacker@example.com",
    "id":999999,
    "createdAt":"1970-01-01T00:00:00",
    "isAdmin":true
  }'

# Check xem id có bị override không
curl http://localhost:8080/api/users/999999
```

**Impact**: HIGH - Có thể bypass validation, set admin flag, hoặc manipulate timestamps.

**Fix**: Use DTO pattern với `@JsonIgnore` trên sensitive fields.

---

### 3. **SQL Injection**

**Mô tả**: Input không được sanitize, có thể inject SQL code.

**Test Cases**:
```bash
# Test search endpoint với SQL injection payloads
curl "http://localhost:8080/api/posts/search?title=test' OR '1'='1"
curl "http://localhost:8080/api/posts/search?title=test'; DROP TABLE users; --"
curl "http://localhost:8080/api/posts/search?title=test' UNION SELECT * FROM users--"

# Test với SQLMap
sqlmap -u "http://localhost:8080/api/posts/search?title=test" \
  --batch --dbs
```

**Note**: Spring Data JPA sử dụng prepared statements nên khó bị SQL injection, nhưng vẫn cần test.

**Impact**: CRITICAL nếu vulnerable - Full database compromise.

---

### 4. **NoSQL Injection (Hazelcast Cache)**

**Mô tả**: Cache key manipulation để access unauthorized data.

**Test Cases**:
```bash
# Cache key là user ID hoặc username
# Thử truy cập với different formats
curl http://localhost:8080/api/users/1
curl http://localhost:8080/api/users/0x1
curl http://localhost:8080/api/users/1.0
curl http://localhost:8080/api/users/username/admin
curl "http://localhost:8080/api/users/username/admin' OR '1'='1"
```

---

### 5. **Information Disclosure via Actuator**

**Test Cases**:
```bash
# ❌ CRITICAL: Lộ database credentials
curl http://localhost:8080/actuator/env | jq '.propertySources[] | select(.name | contains("systemEnvironment"))'

# Check database password
curl http://localhost:8080/actuator/env | grep -i password

# Check all environment variables
curl http://localhost:8080/actuator/env/spring.datasource.password

# ❌ HIGH: Có thể thay đổi log level
curl -X POST http://localhost:8080/actuator/loggers/com.khoa.spring.playground \
  -H "Content-Type: application/json" \
  -d '{"configuredLevel":"TRACE"}'

# Check health details (có thể lộ database info)
curl http://localhost:8080/actuator/health
```

**Impact**: CRITICAL - Lộ secrets, database credentials, có thể DOS qua log manipulation.

**Fix**:
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,prometheus  # Only expose safe endpoints
  endpoint:
    env:
      enabled: false  # Disable env endpoint
```

---

### 6. **XSS (Cross-Site Scripting)**

**Test Cases**:
```bash
# Inject XSS payload vào username
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"<script>alert(document.cookie)</script>","email":"xss@test.com"}'

# Inject XSS vào post content
curl -X POST http://localhost:8080/api/posts \
  -H "Content-Type: application/json" \
  -d '{
    "title":"Normal Title",
    "content":"<img src=x onerror=alert(1)>",
    "userId":1
  }'

# Retrieve và check xem có sanitize không
curl http://localhost:8080/api/posts/1
```

**Impact**: HIGH nếu có frontend - Steal session tokens, phishing.

---

### 7. **DoS (Denial of Service)**

**Test Cases**:
```bash
# 1. Large payload attack
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"$(python3 -c 'print("A"*10000000)')\"}"

# 2. Async delete job flooding
for i in {1..1000}; do
  curl -X DELETE "http://localhost:8080/api/users/1?mode=async" &
done

# 3. Cache exhaustion
for i in {1..100000}; do
  curl -X POST http://localhost:8080/api/users \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"user$i\",\"email\":\"user$i@test.com\"}"
done

# 4. Database connection exhaustion
for i in {1..1000}; do
  curl "http://localhost:8080/api/users" &
done
```

---

### 8. **Race Condition**

**Test Cases**:
```bash
# Concurrent updates trên cùng 1 user
for i in {1..100}; do
  curl -X PUT http://localhost:8080/api/users/1 \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"user$i\",\"email\":\"user$i@test.com\"}" &
done
wait

# Check kết quả
curl http://localhost:8080/api/users/1

# Concurrent deletes
for i in {1..10}; do
  curl -X DELETE "http://localhost:8080/api/users/2?mode=async" &
done
```

---

### 9. **Path Traversal**

**Test Cases**:
```bash
# Thử truy cập files ngoài intended scope
curl "http://localhost:8080/api/users/../../../etc/passwd"
curl "http://localhost:8080/api/users/%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd"
curl "http://localhost:8080/api/users/..;/..;/..;/etc/passwd"
```

---

### 10. **HTTP Method Override**

**Test Cases**:
```bash
# Thử override DELETE method bằng POST
curl -X POST http://localhost:8080/api/users/1 \
  -H "X-HTTP-Method-Override: DELETE"

curl -X GET http://localhost:8080/api/users/1 \
  -H "X-HTTP-Method-Override: DELETE"
```

---

## Automated Testing với OWASP ZAP

### 1. Cấu Hình ZAP

Tạo file `pentest/zap-config.yaml`:

```yaml
env:
  contexts:
    - name: "Spring Playground"
      urls:
        - "http://localhost:8080.*"
      includePaths: []
      excludePaths:
        - "http://localhost:8080/actuator/shutdown.*"
  parameters:
    failOnError: true
    failOnWarning: false
    progressToStdout: true
  vars: {}

jobs:
  - type: passiveScan-config
    parameters:
      maxAlertsPerRule: 10

  - type: spider
    parameters:
      url: "http://localhost:8080"
      maxDuration: 5

  - type: spiderAjax
    parameters:
      url: "http://localhost:8080"
      maxDuration: 5

  - type: passiveScan-wait
    parameters:
      maxDuration: 10

  - type: activeScan
    parameters:
      context: "Spring Playground"
      url: "http://localhost:8080"
      maxDuration: 10

  - type: report
    parameters:
      template: traditional-html
      reportDir: /zap/wrk
      reportFile: zap-report.html
      reportTitle: Spring Playground Security Report
```

### 2. Chạy ZAP Scan

```bash
# Tạo thư mục pentest
mkdir -p pentest

# Chạy ZAP automated scan
docker run -v $(pwd)/pentest:/zap/wrk/:rw \
  -t ghcr.io/zaproxy/zaproxy:stable \
  zap-baseline.py \
  -t http://host.docker.internal:8080 \
  -r zap-report.html
```

Hoặc sử dụng full scan:

```bash
docker run -v $(pwd)/pentest:/zap/wrk/:rw \
  -t ghcr.io/zaproxy/zaproxy:stable \
  zap-full-scan.py \
  -t http://host.docker.internal:8080 \
  -r zap-full-report.html
```

### 3. Review Report

```bash
# Mở report trong browser
open pentest/zap-report.html
# hoặc
firefox pentest/zap-report.html
```

---

## Checklist Bảo Mật

### Authentication & Authorization
- [ ] **CRITICAL**: Implement authentication (Spring Security, JWT, OAuth2)
- [ ] **CRITICAL**: Add authorization checks cho mọi endpoint
- [ ] **CRITICAL**: Fix IDOR vulnerabilities
- [ ] Implement role-based access control (RBAC)
- [ ] Add CSRF protection cho state-changing operations
- [ ] Implement rate limiting

### Input Validation
- [ ] **HIGH**: Validate tất cả user input (size, format, type)
- [ ] **HIGH**: Sanitize output để prevent XSS
- [ ] Use DTO pattern thay vì expose entities directly
- [ ] Implement `@Valid` annotations và bean validation
- [ ] Add input length limits
- [ ] Whitelist validation cho enums/options

### Actuator Security
- [ ] **CRITICAL**: Disable hoặc restrict `/actuator/env`
- [ ] **CRITICAL**: Disable hoặc restrict `/actuator/loggers`
- [ ] Move actuator endpoints sang separate port
- [ ] Add authentication cho actuator endpoints
- [ ] Only expose necessary endpoints
- [ ] Mask sensitive values trong actuator responses

### Database Security
- [ ] Verify prepared statements usage (防 SQL injection)
- [ ] Implement database connection pooling limits
- [ ] Add database query timeouts
- [ ] Encrypt sensitive data at rest
- [ ] Use read-only connections khi possible
- [ ] Implement audit logging

### Cache Security
- [ ] Validate cache keys để prevent cache poisoning
- [ ] Set appropriate TTL cho cached data
- [ ] Implement cache size limits
- [ ] Clear cache on sensitive operations
- [ ] Don't cache sensitive data

### API Security
- [ ] Add request size limits
- [ ] Implement API versioning
- [ ] Add CORS configuration properly
- [ ] Use HTTPS only (trong production)
- [ ] Add security headers (CSP, HSTS, X-Frame-Options, etc.)
- [ ] Implement request/response logging

### Error Handling
- [ ] Don't expose stack traces trong responses
- [ ] Use generic error messages
- [ ] Log detailed errors server-side only
- [ ] Implement global exception handler
- [ ] Return appropriate HTTP status codes

### Dependencies
- [ ] **HIGH**: Scan dependencies cho known vulnerabilities
- [ ] Keep dependencies up to date
- [ ] Use OWASP Dependency Check Maven plugin
- [ ] Review transitive dependencies
- [ ] Pin dependency versions

### Monitoring & Logging
- [ ] Log security events (failed auth, IDOR attempts, etc.)
- [ ] Implement alerting cho suspicious activities
- [ ] Monitor rate of requests per user/IP
- [ ] Track failed operations
- [ ] Implement log aggregation

### Production Deployment
- [ ] Disable debug mode
- [ ] Set `jpa.show-sql=false`
- [ ] Use environment variables cho secrets
- [ ] Implement secret rotation
- [ ] Use container scanning
- [ ] Implement WAF (Web Application Firewall)

---

## Scripts Tự Động

### Pentest Runner Script

Tạo file `pentest/run-pentest.sh`:

```bash
#!/bin/bash

echo "======================================"
echo "Spring Playground Penetration Testing"
echo "======================================"

BASE_URL="http://localhost:8080"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "\n${YELLOW}[1] Testing IDOR Vulnerability${NC}"
echo "Creating test users..."
USER1=$(curl -s -X POST $BASE_URL/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"victim","email":"victim@test.com"}' | jq -r '.id')
echo "Created User 1 with ID: $USER1"

USER2=$(curl -s -X POST $BASE_URL/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"attacker","email":"attacker@test.com"}' | jq -r '.id')
echo "Created User 2 with ID: $USER2"

echo "Testing if User 2 can access User 1's data..."
RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null $BASE_URL/api/users/$USER1)
if [ "$RESPONSE" -eq 200 ]; then
  echo -e "${RED}❌ VULNERABLE: IDOR detected! User 2 can access User 1's data${NC}"
else
  echo -e "${GREEN}✅ SECURE: IDOR protection working${NC}"
fi

echo -e "\n${YELLOW}[2] Testing Actuator Information Disclosure${NC}"
RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null $BASE_URL/actuator/env)
if [ "$RESPONSE" -eq 200 ]; then
  echo -e "${RED}❌ VULNERABLE: /actuator/env is accessible!${NC}"
  echo "Checking for exposed credentials..."
  curl -s $BASE_URL/actuator/env | grep -i "password\|secret\|key" | head -5
else
  echo -e "${GREEN}✅ SECURE: /actuator/env is protected${NC}"
fi

echo -e "\n${YELLOW}[3] Testing SQL Injection${NC}"
PAYLOAD="test' OR '1'='1"
RESPONSE=$(curl -s "$BASE_URL/api/posts/search?title=$PAYLOAD")
echo "Response: $RESPONSE"

echo -e "\n${YELLOW}[4] Testing XSS${NC}"
XSS_PAYLOAD='<script>alert(1)</script>'
curl -s -X POST $BASE_URL/api/users \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"$XSS_PAYLOAD\",\"email\":\"xss@test.com\"}" | jq '.'

echo -e "\n${YELLOW}[5] Testing Mass Assignment${NC}"
curl -s -X POST $BASE_URL/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"hacker","email":"hacker@test.com","id":999999}' | jq '.'

echo -e "\n======================================"
echo "Penetration Testing Complete!"
echo "Review results above for vulnerabilities"
echo "======================================"
```

Chạy:
```bash
chmod +x pentest/run-pentest.sh
./pentest/run-pentest.sh
```

---

## Kết Luận

Dự án này có **nhiều lỗ hổng bảo mật nghiêm trọng** cần fix trước khi deploy production:

### Critical Issues
1. ❌ **No Authentication/Authorization** - Ai cũng có thể truy cập mọi endpoint
2. ❌ **IDOR Vulnerabilities** - User có thể xem/sửa/xóa data của người khác
3. ❌ **Actuator Information Disclosure** - Lộ database credentials và secrets
4. ❌ **No Rate Limiting** - Dễ bị DoS attack

### Recommended Fixes
1. Implement **Spring Security** với JWT hoặc OAuth2
2. Add **authorization checks** trong mọi endpoint
3. **Restrict actuator endpoints** hoặc move sang separate port với authentication
4. Implement **rate limiting** với Bucket4j hoặc Spring Cloud Gateway
5. Add **input validation** và **output sanitization**
6. Use **DTO pattern** thay vì expose entities
7. Add **security headers** và **CORS configuration**
8. Implement **audit logging** cho security events

### Next Steps
1. Fix critical issues trước
2. Run automated scan với OWASP ZAP
3. Implement security testing trong CI/CD pipeline
4. Regular dependency scanning với OWASP Dependency Check
5. Penetration testing định kỳ

---

## Tài Liệu Tham Khảo

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Spring Security Documentation](https://spring.io/projects/spring-security)
- [OWASP ZAP User Guide](https://www.zaproxy.org/docs/)
- [Spring Boot Security Best Practices](https://spring.io/guides/topicals/spring-security-architecture)
- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)
